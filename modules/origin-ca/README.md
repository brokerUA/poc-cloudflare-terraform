# origin-ca module

Issue Cloudflare Origin CA certificates for one or more hostnames (for example, `example.com` and `*.example.com`). Use this certificate to encrypt traffic between Cloudflare and your origin server.

## Prerequisites

- Terraform `>= 1.5.0` and the Cloudflare provider `>= 5.0.0` (the module declares these in `versions.tf`).
- A Cloudflare API token with Account scope permissions to issue Origin CA certificates.
  - At minimum, the token should allow creating Origin CA certificates in the target account.
- Optional but recommended: install the Cloudflare Origin CA root certificate on your origin server so that your origin trusts the certificate chain presented by Cloudflare.

Example provider configuration:

```hcl
provider "cloudflare" {
  api_token = var.cloudflare_api_token
}
```

## Behavior and CSR generation

Cloudflare's API for `cloudflare_origin_ca_certificate` requires a CSR if you want to keep your private key local. This module provides two flows:

- CSR provided (advanced): you pass a PEM CSR via `csr`, the module forwards it to Cloudflare. You manage your private key outside this module.
- CSR omitted (simple): the module automatically generates a private key and CSR (using the `tls` provider), submits the CSR to Cloudflare, and exposes the generated private key and CSR as sensitive outputs. Your private key never leaves Terraform state unless you explicitly output or store it.

Important security note: The generated private key is stored in Terraform state. Treat the state file as a secret. Prefer using a secure backend with proper access controls.

## Inputs

- `hostnames` (list(string), required)
  - Hostnames to include in the certificate (e.g., `["example.com", "*.example.com"]`).
- `request_type` (string, optional, default: `"origin-ecc"`)
  - Key algorithm for the Origin CA certificate. One of: `origin-ecc`, `origin-rsa`.
- `requested_validity` (number, optional, default: `5475`)
  - Requested certificate validity in days (e.g., `5475` = 15 years).
- `csr` (string, optional, default: `null`, sensitive)
  - PEM-encoded CSR. If omitted, the module generates a private key and CSR internally and submits it to Cloudflare.

## Outputs

- `certificate`
  - PEM-encoded Origin CA certificate.
- `generated` (bool)
  - Whether the module generated a key and CSR (true when input `csr` was null).
- `csr` (sensitive)
  - CSR used for the request (echoes the input, null when generated internally).
- `generated_csr_pem` (sensitive)
  - CSR generated by the module when `csr` was omitted (null otherwise).
- `generated_private_key_pem` (sensitive)
  - Private key generated by the module when `csr` was omitted (null otherwise). Handle securely.
- `expires_on`
  - Certificate expiration timestamp.
- `id`
  - Origin CA certificate ID in Cloudflare.
- `hostnames`
  - Hostnames included in the certificate.
- `request_type`
  - Final request type (`origin-ecc` or `origin-rsa`).

## Minimal example

```hcl
variable "cloudflare_api_token" { type = string }

provider "cloudflare" {
  api_token = var.cloudflare_api_token
}

module "origin_ca" {
  source             = "../origin-ca"
  hostnames          = ["example.com", "*.example.com"]
  # request_type     = "origin-ecc"   # optional
  # requested_validity = 5475          # optional
  # csr              = null            # omit to auto-generate key + CSR
}

output "origin_cert" {
  value = module.origin_ca.certificate
}
```

## Notes

- Handle any sensitive outputs securely (especially `generated_private_key_pem`). Marking values as `sensitive` prevents them from being printed in logs and CLI output, but you should still store them securely and avoid committing them to VCS.
